#!/usr/bin/env bash
set -eu
set -o pipefail

function command_help() {
  echo "\
    $0 [-h|--help] IMAGE:TAG
  "
}

function error_msg() {
  echo ""
  echo "ERROR: $*"
  echo ""
}

function exit_msg() {
  error_msg "$@"
  command_help
  echo ""
  exit 1
}

case "$1" in
    mongo|mongodb)
        docker run --name persistent-mongo -d --rm -it -p 27017:27017 mongo --smallfiles
        trap "docker rm -f persistent-mongo" EXIT
        stack test persistent-test --flag persistent-test:mongodb --exec persistent-test
        ;;
    *)
        exit_msg "don't yet know how to test: $1, please teach me!"
        ;;
esac
